<!DOCTYPE html>
<html>
  <title>Arduino-ESP32 WS2812B_LED_Strip-Web_Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html {font-family: Helvetica, sans-serif;}
    h1 {font-size: 1.1rem; color:#00878F;}

    label {font-size: 14px;}

    .div_Form {
      margin: auto;
      width: 90%;
      border:1px solid #D8D8D8;
      border-radius: 10px;
      background-color: #f2f2f2;
      padding: 9px 9px;
    }

    .myButton {
      display: inline-block;
      padding: 5px 25px;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      outline: none;
      color: #fff;
      background-color: #00878F;
      border: none;
      border-radius: 8px;
      box-shadow: 0 3px #999;
    }
    .myButton:hover {background-color: #015e63}
    .myButton:active {background-color: #015e63; box-shadow: 0 1px #666; transform: translateY(2px);}
    .myButton:disabled {background-color: #666; box-shadow: 0 1px #666; transform: translateY(2px);}
  </style>
  
  <body>
    <div style="text-align: center;">
      <h1>Happy Christmas from 13 Tenpenny</h1>
    </div>

    <div class="div_Form">
      <form>
        <label for="Keys_TXT">Key :</label>
        <input type="password" id="Keys_TXT" name="Keys_TXT" maxlength="20" placeholder="Enter key here..." />
        
        <br>
        
        <hr style="border: 1px solid #e6e6e6;">
        
        <label>Brightness :</label>
        <input type="text" value="50" id="input_Brightness" maxlength="3" size="3" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');" /> (0-255)
        
        <hr style="border: 1px solid #e6e6e6;">
        
        <input type="checkbox" id="checkbox_LSC" name="checkbox_LSC">
        <label>LED strip colour :</label>
        <input type="color" id="favcolor" name="favcolor" value="#ff0000">
        <br><br>
        <input type="checkbox" id="checkbox_LED_Strip_Effect" name="checkbox_LED_Strip_Effect">
        <label>LED strip effect :</label>
        <select name="LED_Strip_Effect" id="LED_Strip_Effect">
          <option value="A">Random</option>
          <option value="B">Christmas</option>
          <option value="C">Rainbow</option>
        </select>        
        <hr style="border: 1px solid #e6e6e6;">
        
        <input type="checkbox" id="checkbox_No_Marble_Effect" name="checkbox_No_Marble_Effect">
        <label>No marble effect :</label>
        <select name="No_Marble_Effect" id="No_Marble_Effect">
          <option value="A">Random</option>
          <option value="B">Christmas</option>
          <option value="C">Rainbow</option>
        </select>

        <hr style="border: 1px solid #e6e6e6;">
        
        <br><br>
        
        <hr style="border: 1px solid #e6e6e6;">
        
        <button type="button" class="myButton" id="BTN_Submit" onclick="BTN_Submit_Click()">Submit</button>
        <button type="button" class="myButton" id="BTN_Get_Settings" onclick="BTN_Get_Settings_Click()">Get Settings</button>
      </form>
    </div>

    <script>
      // Function to send settings to the server.
      function BTN_Submit_Click() {
        var key_TXT = document.getElementById("Keys_TXT").value;

        if (key_TXT == "") {
          alert("Error ! \rThe key cannot be empty.");
          return;
        }
        
        var LED_Strip_Brightness = document.getElementById("input_Brightness").value;
        
        if (LED_Strip_Brightness == "") {
          alert("Error ! \rBrightness cannot be empty.");
          return;
        }
        
        var LED_Strip_Color_Sta = document.getElementById("checkbox_LSC").checked;
        var LED_Strip_Color = hexToRgb(document.getElementById("favcolor").value);
        var LED_Strip_Color_R = LED_Strip_Color[0];
        var LED_Strip_Color_G = LED_Strip_Color[1];
        var LED_Strip_Color_B = LED_Strip_Color[2];

        var LED_Strip_Effect_Sta = document.getElementById("checkbox_LED_Strip_Effect").checked;
        var LED_Strip_Effect = document.getElementById("LED_Strip_Effect").value; 

        var No_Marble_Effect_Sta = document.getElementById("checkbox_No_Marble_Effect").checked;
        var No_Marble_Effect_Eff = document.getElementById("No_Marble_Effect").value;

        var msg;
        msg = "key=" + key_TXT;
        msg += "&sta=set";
        msg += "&LED_Strip_Color_Brt=" + LED_Strip_Brightness;
        msg += "&LED_Strip_Color_Sta=" + Number(LED_Strip_Color_Sta);
        msg += "&LED_Strip_Color_R=" + LED_Strip_Color_R + "&LED_Strip_Color_G=" + LED_Strip_Color_G + "&LED_Strip_Color_B=" + LED_Strip_Color_B;
        msg += "&LED_Strip_Effect_Sta=" + Number(LED_Strip_Effect_Sta) + "&LED_Strip_Effect=" + LED_Strip_Effect;
        msg += "&No_Marble_Effect_Sta=" + Number(No_Marble_Effect_Sta) + "&No_Marble_Effect_Eff=" + No_Marble_Effect_Eff;
        
        Send("set", msg);
      }

      // Function to get saved settings from the server.
      function BTN_Get_Settings_Click() {
        var key_TXT = document.getElementById("Keys_TXT").value;

        if (key_TXT == "") {
          alert("Error ! \rThe key cannot be empty.");
          return;
        }
        
        var msg;
        msg = "key=" + key_TXT;
        msg += "&sta=get";
        
        Send("get", msg);
      }
      
      function hexToRgb(hex) {
        const normal = hex.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
        if (normal) return normal.slice(1).map(e => parseInt(e, 16));

        const shorthand = hex.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);
        if (shorthand) return shorthand.slice(1).map(e => 0x11 * parseInt(e, 16));

        return null;
      }
      //________________________________________________________________________________
      
      function rgbToHex(red, green, blue) {
        const rgb = (red << 16) | (green << 8) | (blue << 0);
        return '#' + (0x1000000 + rgb).toString(16).slice(1);
      }

      // Function to apply settings received from the server.
      function apply_the_Received_Settings(texts) {
        const myArray_Getting_Texts = texts.split("|");
        
        var LED_Strip_Brightness = myArray_Getting_Texts[0];
        
        var LED_Strip_Color_Sta = myArray_Getting_Texts[1];
        var LED_Strip_Color_R = myArray_Getting_Texts[2];
        var LED_Strip_Color_G = myArray_Getting_Texts[3];
        var LED_Strip_Color_B = myArray_Getting_Texts[4];
        var LED_Strip_Color = rgbToHex(LED_Strip_Color_R, LED_Strip_Color_G, LED_Strip_Color_B);
        var LED_Strip_Delay = myArray_Getting_Texts[5];
        
        var Eff_1_Sta = myArray_Getting_Texts[6];
        var Eff_1_Eff = myArray_Getting_Texts[7];
        
        document.getElementById("input_Brightness").value = LED_Strip_Brightness;
        
        if (LED_Strip_Color_Sta == "1") {
          document.getElementById("checkbox_LSC").checked = true;
          document.getElementById("favcolor").value = LED_Strip_Color;
        } else {
          document.getElementById("checkbox_LSC").checked = false;
          document.getElementById("favcolor").value = LED_Strip_Color;
        }
        
        if (Eff_1_Sta == "1") {
          document.getElementById("checkbox_No_Marble_Effect").checked = true;
          document.getElementById("No_Marble_Effect").value = Eff_1_Eff;
        } else {
          document.getElementById("checkbox_No_Marble_Effect").checked = false;
          document.getElementById("No_Marble_Effect").value = Eff_1_Eff;
        }
      }
      //________________________________________________________________________________

      //________________________________________________________________________________ function Send(sta, msg)
      function Send(sta, msg) {
        if (window.XMLHttpRequest) {
          // code for IE7+, Firefox, Chrome, Opera, Safari
          xmlhttp = new XMLHttpRequest();
        } else {
          // code for IE6, IE5
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            if (this.responseText == "+ERR") {
              alert("Error !\rWrong Key !\rPlease enter the correct key.");
              return;
            }
            
            if (sta == "get") {
              apply_the_Received_Settings(this.responseText);
            }
          }
        }
        xmlhttp.open("GET", "settings?" + msg, true);
        xmlhttp.send();
      }
    </script>
  </body>
</html>